name: Release Extremer

on:
  push:
    tags:
      - "extremer-v*"

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "yarn"
          cache-dependency-path: src/yarn.lock

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.21"
          cache-dependency-path: |
            Extremer/go.sum
            LocalBridge/go.sum

      - name: Install Wails CLI
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Build Frontend
        working-directory: src
        run: |
          yarn install --frozen-lockfile
          yarn build

      - name: Build LocalBridge
        working-directory: LocalBridge
        run: |
          go build -ldflags="-s -w" -o localbridge.exe ./cmd/lb

      - name: Prepare Build Structure
        shell: pwsh
        run: |
          # Create build directories
          New-Item -ItemType Directory -Force -Path Extremer/build/web
          New-Item -ItemType Directory -Force -Path Extremer/build/package/bin
          New-Item -ItemType Directory -Force -Path Extremer/build/package/config
          New-Item -ItemType Directory -Force -Path Extremer/build/package/logs
          New-Item -ItemType Directory -Force -Path Extremer/build/package/mfw
          New-Item -ItemType Directory -Force -Path Extremer/build/package/ocr
          New-Item -ItemType Directory -Force -Path Extremer/frontend/dist
          
          # Copy frontend build
          Copy-Item -Recurse -Force src/dist/* Extremer/build/web/
          Copy-Item -Recurse -Force src/dist/* Extremer/frontend/dist/
          
          # Copy LocalBridge
          Copy-Item LocalBridge/localbridge.exe Extremer/build/package/bin/
          
          # Copy config templates
          Copy-Item Extremer/assets/config/extremer.json.template Extremer/build/package/config/extremer.json
          Copy-Item Extremer/assets/config/localbridge.json.template Extremer/build/package/config/localbridge.json

      - name: Build Wails App
        working-directory: Extremer
        run: wails build -clean -platform windows/amd64

      - name: Package Release
        shell: pwsh
        run: |
          $VERSION = "${{ github.ref_name }}" -replace "extremer-v", ""
          
          # Copy Wails output to package
          Copy-Item Extremer/build/bin/MaaPipelineExtremer.exe Extremer/build/package/
          
          # Copy web assets
          Copy-Item -Recurse -Force Extremer/build/web/* Extremer/build/package/web/
          
          # Create full package
          Compress-Archive -Path Extremer/build/package/* -DestinationPath "Extremer/build/MaaPipelineExtremer-$VERSION-win64.zip"
          
          # Create component packages
          Compress-Archive -Path Extremer/build/package/web/* -DestinationPath "Extremer/build/frontend-$VERSION.zip"
          Compress-Archive -Path Extremer/build/package/bin/localbridge.exe -DestinationPath "Extremer/build/localbridge-$VERSION-win64.zip"

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: extremer-windows
          path: |
            Extremer/build/MaaPipelineExtremer-*.zip
            Extremer/build/frontend-*.zip
            Extremer/build/localbridge-*.zip

  create-release:
    needs: build-windows
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: extremer-windows
          path: artifacts

      - name: Generate Manifest
        run: |
          VERSION="${{ github.ref_name }}"
          VERSION="${VERSION#extremer-v}"
          
          # Calculate SHA256 for each file
          EXTREMER_SHA=$(sha256sum artifacts/MaaPipelineExtremer-${VERSION}-win64.zip | cut -d' ' -f1)
          FRONTEND_SHA=$(sha256sum artifacts/frontend-${VERSION}.zip | cut -d' ' -f1)
          LB_SHA=$(sha256sum artifacts/localbridge-${VERSION}-win64.zip | cut -d' ' -f1)
          
          # Generate manifest.json
          cat > artifacts/manifest.json << EOF
          {
            "version": "${VERSION}",
            "components": {
              "extremer": {
                "version": "${VERSION}",
                "url": "https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/MaaPipelineExtremer-${VERSION}-win64.zip",
                "sha256": "${EXTREMER_SHA}",
                "changelog": "Release ${VERSION}"
              },
              "frontend": {
                "version": "${VERSION}",
                "url": "https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/frontend-${VERSION}.zip",
                "sha256": "${FRONTEND_SHA}",
                "changelog": "Release ${VERSION}"
              },
              "localbridge": {
                "version": "${VERSION}",
                "url": "https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/localbridge-${VERSION}-win64.zip",
                "sha256": "${LB_SHA}",
                "changelog": "Release ${VERSION}"
              },
              "mfw": {
                "version": "2.0.0",
                "url": "https://github.com/MaaXYZ/MaaFramework/releases/download/v2.0.0/MAA-win-x86_64-v2.0.0.zip",
                "sha256": "",
                "changelog": "MaaFramework core library"
              },
              "ocr": {
                "version": "1.0.0",
                "url": "https://github.com/MaaXYZ/MaaCommonAssets/releases/download/v1.0.0/MaaCommonAssets-v1.0.0.zip",
                "sha256": "",
                "changelog": "OCR model resources"
              }
            },
            "updateChannel": "stable"
          }
          EOF

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/MaaPipelineExtremer-*.zip
            artifacts/frontend-*.zip
            artifacts/localbridge-*.zip
            artifacts/manifest.json
          draft: false
          prerelease: ${{ contains(github.ref_name, 'beta') || contains(github.ref_name, 'alpha') }}
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
