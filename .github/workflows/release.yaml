name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: yarn

      - name: Install dependencies
        run: yarn install

      - name: Modify config for production build
        run: |
          # å°†configStore.tsä¸­çš„globalConfig.devæ”¹ä¸ºfalse
          sed -i 's/dev: true,/dev: false,/g' src/stores/configStore.ts
          echo "å·²ä¿®æ”¹configStore.tsä¸­çš„devé…ç½®ä¸ºfalse"

      - name: Build project
        run: yarn build

      - name: Create archive
        run: |
          cd dist
          zip -r ../MaaPipelineEditor-${{ github.ref_name }}-stable.zip .
          cd ..

      - name: Generate Changelog
        id: changelog
        run: |
          # è·å–ä¸Šä¸€ä¸ªtag
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [ -z "$PREVIOUS_TAG" ]; then
            echo "è¿™æ˜¯ç¬¬ä¸€ä¸ªreleaseï¼Œè·å–æ‰€æœ‰commits"
            COMMITS=$(git log --pretty=format:"%s (%h)" --no-merges)
          else
            echo "è·å–ä» $PREVIOUS_TAG åˆ° ${{ github.ref_name }} çš„commits"
            COMMITS=$(git log --pretty=format:"%s (%h)" --no-merges $PREVIOUS_TAG..HEAD)
          fi

          # åˆå§‹åŒ–å„ç±»å‹çš„commits
          FEAT=""
          FIX=""
          DOCS=""
          STYLE=""
          REFACTOR=""
          PERF=""
          TEST=""
          CHORE=""
          OTHERS=""

          # åˆ†ç±»commits
          while IFS= read -r line; do
            if [[ $line =~ ^feat[:(] ]]; then
              FEAT="${FEAT}- ${line}\n"
            elif [[ $line =~ ^fix[:(] ]]; then
              FIX="${FIX}- ${line}\n"
            elif [[ $line =~ ^docs[:(] ]]; then
              DOCS="${DOCS}- ${line}\n"
            elif [[ $line =~ ^style[:(] ]]; then
              STYLE="${STYLE}- ${line}\n"
            elif [[ $line =~ ^refactor[:(] ]]; then
              REFACTOR="${REFACTOR}- ${line}\n"
            elif [[ $line =~ ^perf[:(] ]]; then
              PERF="${PERF}- ${line}\n"
            elif [[ $line =~ ^test[:(] ]]; then
              TEST="${TEST}- ${line}\n"
            elif [[ $line =~ ^chore[:(] ]]; then
              CHORE="${CHORE}- ${line}\n"
            else
              OTHERS="${OTHERS}- ${line}\n"
            fi
          done <<< "$COMMITS"

          # æŒ‰é¡ºåºç»„è£…changelogå†…å®¹
          CHANGES=""
          
          if [ -n "$FEAT" ]; then
            CHANGES="${CHANGES}### âœ¨ æ–°åŠŸèƒ½\n\n${FEAT}\n"
          fi
          
          if [ -n "$FIX" ]; then
            CHANGES="${CHANGES}### ğŸ› Bug ä¿®å¤\n\n${FIX}\n"
          fi
          
          if [ -n "$PERF" ]; then
            CHANGES="${CHANGES}### âš¡ æ€§èƒ½ä¼˜åŒ–\n\n${PERF}\n"
          fi
          
          if [ -n "$REFACTOR" ]; then
            CHANGES="${CHANGES}### â™»ï¸ ä»£ç é‡æ„\n\n${REFACTOR}\n"
          fi
          
          if [ -n "$DOCS" ]; then
            CHANGES="${CHANGES}### ğŸ“ æ–‡æ¡£æ›´æ–°\n\n${DOCS}\n"
          fi
          
          if [ -n "$STYLE" ]; then
            CHANGES="${CHANGES}### ğŸ’„ æ ·å¼è°ƒæ•´\n\n${STYLE}\n"
          fi
          
          if [ -n "$TEST" ]; then
            CHANGES="${CHANGES}### âœ… æµ‹è¯•ç›¸å…³\n\n${TEST}\n"
          fi
          
          if [ -n "$CHORE" ]; then
            CHANGES="${CHANGES}### ğŸ”§ å…¶ä»–æ›´æ–°\n\n${CHORE}\n"
          fi
          
          if [ -n "$OTHERS" ]; then
            CHANGES="${CHANGES}### ğŸ“¦ å…¶ä»–æäº¤\n\n${OTHERS}\n"
          fi

          # ç”Ÿæˆå®Œæ•´changelog
          CHANGELOG="**Full Changelog**: https://github.com/kqcoxn/MaaPipelineEditor/compare/$PREVIOUS_TAG...${{ github.ref_name }}

          ## ğŸ“ æ›´æ–°å†…å®¹

          ${CHANGES}
          ## ğŸŒ åœ¨çº¿ä½¿ç”¨

          æ¨èæ‚¨ä½¿ç”¨ [åœ¨çº¿æ–¹æ¡ˆ](https://github.com/kqcoxn/MaaPipelineEditor?tab=readme-ov-file#%E5%BC%80%E7%AE%B1%E5%8D%B3%E7%94%A8)ï¼ŒRelease ä»…ä½œä¸ºç½‘ç«™å´©æºƒæ—¶å¤‡ç”¨è‡ªéƒ¨ç½²æ–¹æ¡ˆ"

          # å°†changelogä¿å­˜åˆ°æ–‡ä»¶
          echo -e "$CHANGELOG" > CHANGELOG.md

          # è¾“å‡ºåˆ°GitHub Actions
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo -e "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            MaaPipelineEditor-${{ github.ref_name }}-stable.zip
          body_path: CHANGELOG.md
          generate_release_notes: false
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
