---
title: 基础流程控制
permalink: /practices/process
categories:
  - 最佳实践
tags:
  - 最佳实践
---

基础流程控制指通过 Pipeline 实现常见的流程结构，如条件、循环等。

## 条件判断

条件判断指可能在流程过程中遇到多种可能的情况，要求 mfw 根据具体的画面情况执行不同的操作，或进入不同的流程分支。

对于条件控制，只需设置多个 `next` 数值即可，next 的顺序即为 `if`、`elif` 的顺序。若需 `else`，则可以使用 `on_error` 表示。

例如，我们有如下需求：

> 1. 如果屏幕中存在图片 1，则执行点击图片 1 操作；
> 2. 如果屏幕中存在某个图片 2，则执行长按图片 2 操作；
> 3. 否则，什么都不做。

则可以：

![](/images/practice/process/条件判断.png)

```json
{
  "开始": {
    "recognition": { "type": "DirectHit", "param": {} },
    "action": { "type": "DoNothing", "param": {} },
    "timeout": 2000,
    "next": ["if", "elif"],
    "on_error": ["else"]
  },
  "if": {
    "recognition": {
      "type": "TemplateMatch",
      "param": { "template": ["path/to/图片1"] }
    },
    "action": { "type": "Click", "param": {} }
  },
  "elif": {
    "recognition": {
      "type": "TemplateMatch",
      "param": { "template": ["path/to/图片2"] }
    },
    "action": { "type": "LongPress", "param": {} }
  },
  "else": {
    "recognition": { "type": "DirectHit", "param": {} },
    "action": { "type": "DoNothing", "param": {} }
  }
}
```

## 循环

循环指在流程中重复执行某段操作，直到满足某个条件为止。在 Pipeline 中，您有多重方案可以实现循环结构。

### 基于 next 优先级的循环

next 字段可以接收一个列表，按照列表下标的顺序依次检测，就近命中。

例如，我们有如下需求：

> 循环执行点击图片 1 操作，直到屏幕中出现图片 2。

则可以：

![](/images/practice/process/next循环.png)

```json
{
  "跳出条件": {
    "recognition": {
      "type": "TemplateMatch",
      "param": { "template": ["path/to/图片2"] }
    },
    "action": { "type": "DoNothing", "param": {} }
  },
  "循环条件与操作": {
    "recognition": {
      "type": "TemplateMatch",
      "param": { "template": ["path/to/图片1"] }
    },
    "action": { "type": "Click", "param": {} },
    "next": ["跳出条件", "循环条件与操作"]
  }
}
```

在这个案例中，我们仅需将第一个 `next` 字段设置为跳出条件（新元素），在出现新元素时则立即跳出，否则再次执行自循环。

### 基于 interrupt 的循环

interrupt 字段可以接收一个列表，当 next 字段全部没有命中时，按照列表下标的顺序依次检测，就近命中，**且在执行完后续所有 next 后返回进入 interrupt 的节点，并重置 timeout 时间**。

基于 next 优先级的循环都可以使用基于 interrupt 的循环代替，它拥有更高的可读性：

![](/images/practice/process/interrupt循环1.png)

```json
{
  "跳出条件": {
    "recognition": {
      "type": "TemplateMatch",
      "param": { "template": ["path/to/图片2"] }
    },
    "action": { "type": "DoNothing", "param": {} }
  },
  "循环条件与操作": {
    "recognition": {
      "type": "TemplateMatch",
      "param": { "template": ["path/to/图片1"] }
    },
    "action": { "type": "Click", "param": {} }
  },
  "循环前操作": {
    "recognition": { "type": "DirectHit", "param": {} },
    "action": { "type": "DoNothing", "param": {} },
    "next": ["跳出条件"],
    "interrupt": ["循环条件与操作"]
  }
}
```

同时，它可以更方便的解决一些反向操作，例如我们有如下需求：

> 循环执行点击图片 1 操作，直到屏幕中不存在图片 1 为止。

则可以：

![](/images/practice/process/interrupt循环2.png)

```json
{
  "跳出条件": {
    "recognition": {
      "type": "TemplateMatch",
      "param": { "template": ["path/to/图片1"] }
    },
    "action": { "type": "DoNothing", "param": {} },
    "inverse": true
  },
  "循环条件与操作": {
    "recognition": {
      "type": "TemplateMatch",
      "param": { "template": ["path/to/图片1"] }
    },
    "action": { "type": "Click", "param": {} }
  },
  "循环前操作": {
    "recognition": { "type": "DirectHit", "param": {} },
    "action": { "type": "DoNothing", "param": {} },
    "next": ["跳出条件"],
    "interrupt": ["循环条件与操作"]
  }
}
```

### 基于 on_error 的循环

on_error 字段可以接收一个列表，当 timeout 后若 next 与 interrupt 字段全部没有命中时，按照列表下标的顺序依次检测，就近命中。

此类循环常用在没有一个明确的结束条件下，或希望在一定时间检测不到某个元素时才跳出循环。

例如，我们有如下需求：

> 循环执行点击图片 1 操作，直到五秒内屏幕中不再存在图片 1 为止。

则可以：

![](/images/practice/process/on_error循环.png)

```json
{
  "循环": {
    "recognition": {
      "type": "TemplateMatch",
      "param": { "template": ["path/to/图片1"] }
    },
    "action": { "type": "Click", "param": {} },
    "timeout": 5000,
    "next": ["循环"],
    "on_error": ["后续操作"]
  },
  "后续操作": {
    "recognition": { "type": "DirectHit", "param": {} },
    "action": { "type": "DoNothing", "param": {} }
  }
}
```
