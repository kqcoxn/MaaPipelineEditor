# 最佳实践

<cite>
**本文档中引用的文件**  
- [基础流程控制.md](file://docsite/docs/02.最佳实践/10.基础流程控制.md)
- [nodeTemplates.ts](file://src/data/nodeTemplates.ts)
- [types.ts](file://src/stores/flow/types.ts)
- [constants.ts](file://src/components/flow/nodes/constants.ts)
- [edgeLinker.ts](file://src/core/parser/edgeLinker.ts)
- [nodeSlice.ts](file://src/stores/flow/slices/nodeSlice.ts)
- [edgeSlice.ts](file://src/stores/flow/slices/edgeSlice.ts)
- [schema.ts](file://src/core/fields/other/schema.ts)
- [ErrorPanel.tsx](file://src/components/panels/ErrorPanel.tsx)
</cite>

## 目录
1. [基础流程控制](#基础流程控制)
2. [提高可维护性的技巧](#提高可维护性的技巧)
3. [性能优化策略](#性能优化策略)
4. [复杂资源收集流程案例](#复杂资源收集流程案例)
5. [状态管理与复杂条件分支](#状态管理与复杂条件分支)

## 基础流程控制

MaaPipelineEditor 提供了多种流程控制机制，帮助用户设计清晰、健壮的自动化流程。通过合理组织节点、连接逻辑顺序和配置错误处理机制，可以构建出高效可靠的自动化工作流。

### 条件判断

在自动化流程中，条件判断是实现分支逻辑的核心。MaaPipelineEditor 支持通过 `next` 字段的顺序来定义 `if` 和 `elif` 的执行优先级。若需要实现 `else` 逻辑，可以使用 `on_error` 字段。

当一个节点配置了多个 `next` 目标时，系统会按照列表顺序依次检测，优先匹配最先命中的目标。如果所有 `next` 条件都未满足，则会执行 `on_error` 中定义的路径。这种设计使得复杂的条件分支可以通过简单的连接关系来实现。

例如，当需要根据屏幕内容执行不同操作时：
- 如果识别到图片1，则点击图片1
- 否则如果识别到图片2，则长按图片2  
- 否则执行默认操作

这种逻辑可以通过设置 `next` 列表和 `on_error` 来实现，确保流程能够根据实际情况灵活跳转。

**Section sources**
- [基础流程控制.md](file://docsite/docs/02.最佳实践/10.基础流程控制.md#条件判断)

### 循环结构

MaaPipelineEditor 提供了多种实现循环的方案，以满足不同的业务需求。

#### 基于 next 优先级的循环

通过将 `next` 字段设置为包含自身的列表，可以实现自循环。系统会按照 `next` 列表的顺序进行检测，当循环条件满足时继续执行，直到遇到跳出条件。

这种循环模式适用于需要持续执行某项操作直到满足特定条件的场景，如持续点击某个按钮直到新界面出现。

#### 基于 jump_back 的循环

`jump_back` 是一种特殊的循环机制，当 `next` 字段全部未命中时，系统会检查 `jump_back` 列表。与普通循环不同的是，`jump_back` 在执行完后续所有 `next` 后会返回到进入 `jump_back` 的节点，并重置超时时间。

这种机制提供了更高的可读性，特别适合实现反向操作，如持续执行某个动作直到目标元素消失。

#### 基于 on_error 的循环

`on_error` 循环适用于没有明确结束条件的场景。当设置的超时时间内 `next` 和 `jump_back` 都未命中时，系统会执行 `on_error` 中定义的路径。

这种循环常用于需要在一定时间内持续检测某个元素是否存在的情况，为用户提供了一种基于时间的循环控制方式。

**Section sources**
- [基础流程控制.md](file://docsite/docs/02.最佳实践/10.基础流程控制.md#循环)

## 提高可维护性的技巧

为了确保自动化流程的长期可维护性，建议采用以下最佳实践。

### 使用注释节点

在复杂的流程中，使用专门的注释节点可以帮助团队成员快速理解流程的设计意图。虽然 MaaPipelineEditor 本身没有专门的注释节点类型，但可以通过创建具有描述性标签的空节点来实现类似功能。

将关键决策点、业务逻辑说明或注意事项记录在节点标签中，可以显著提高流程的可读性。特别是在团队协作环境中，良好的注释习惯能够减少沟通成本，提高开发效率。

### 模块化设计

将复杂的自动化流程分解为多个功能模块是提高可维护性的关键。每个模块应该专注于完成一个特定的业务功能，如登录验证、资源收集或任务完成等。

通过外部节点（External Node）和重定向节点（Anchor Node）可以实现模块间的连接。这种设计模式不仅使流程结构更加清晰，还便于单独测试和调试各个模块。

模块化设计的优势在于：
- 便于团队分工协作
- 降低单个流程的复杂度
- 提高代码复用率
- 简化问题排查过程

**Section sources**
- [nodeTemplates.ts](file://src/data/nodeTemplates.ts)
- [constants.ts](file://src/components/flow/nodes/constants.ts)

### 命名规范

良好的命名规范是确保流程可读性的基础。建议采用以下命名策略：

1. **语义化命名**：节点名称应该准确描述其功能，如"登录_检查账号"、"战斗_开始"等。
2. **层级结构**：使用下划线分隔功能模块和具体操作，形成清晰的层级关系。
3. **一致性**：在整个项目中保持命名风格的一致性，避免混用不同的命名约定。

合理的命名不仅有助于当前开发者的理解，也为后续的维护和升级提供了便利。

**Section sources**
- [nodeSlice.ts](file://src/stores/flow/slices/nodeSlice.ts)

## 性能优化策略

为了确保自动化流程的高效执行，需要关注以下几个性能优化方面。

### 避免不必要的识别循环

频繁的图像识别操作会消耗大量计算资源，影响整体执行效率。建议采取以下措施：

1. **合理设置识别间隔**：通过调整 `pre_delay` 和 `post_delay` 参数，避免过于频繁的识别尝试。
2. **使用适当的识别算法**：根据场景选择最适合的识别方式，如模板匹配、OCR 或特征匹配。
3. **限定识别区域**：通过设置 `roi` 参数，将识别范围限制在必要的区域内，减少计算量。

### 合理设置超时参数

超时参数（timeout）的设置直接影响流程的响应速度和稳定性。过短的超时可能导致误判，而过长的超时则会降低整体效率。

建议根据具体操作的预期响应时间来设置超时值：
- 简单的界面切换：1-2秒
- 网络请求相关操作：3-5秒  
- 复杂的动画或加载过程：5-10秒

同时，可以利用 `max_hit` 参数限制节点的最大识别次数，防止无限循环。

### 优化延迟配置

虽然 `pre_delay` 和 `post_delay` 可以用于控制操作间隔，但过度依赖延迟会影响流程的灵活性和响应速度。

推荐的做法是：
- 尽量通过识别结果来驱动流程前进
- 使用必要的中间节点作为流程控制点
- 仅在确实需要等待的情况下使用延迟

**Section sources**
- [schema.ts](file://src/core/fields/other/schema.ts)

## 复杂资源收集流程案例

以一个复杂的资源收集流程为例，展示优秀的设计模式。

### 流程结构设计

一个典型的资源收集流程通常包含以下模块：
1. **初始化模块**：检查当前状态，确定起始位置
2. **导航模块**：移动到资源区域
3. **收集模块**：执行具体的资源收集操作
4. **验证模块**：确认资源是否成功收集
5. **异常处理模块**：处理各种可能的异常情况

通过将这些功能模块化，可以构建出既灵活又可靠的自动化流程。

### 错误处理机制

在资源收集过程中，可能会遇到各种异常情况，如网络延迟、界面加载失败或资源已被他人收集等。

建议采用分层的错误处理策略：
- **局部错误处理**：在每个关键操作后设置适当的 `on_error` 路径
- **全局错误处理**：设置专门的错误处理节点，统一处理各种异常情况
- **重试机制**：对于临时性错误，可以设计重试逻辑

通过 `ErrorPanel` 组件可以实时监控流程执行中的错误信息，帮助快速定位和解决问题。

**Section sources**
- [基础流程控制.md](file://docsite/docs/02.最佳实践/10.基础流程控制.md)
- [ErrorPanel.tsx](file://src/components/panels/ErrorPanel.tsx)

## 状态管理与复杂条件分支

对于进阶用户，掌握状态管理和复杂条件分支的实现方法至关重要。

### 状态管理

虽然 MaaPipelineEditor 本身不直接提供状态变量，但可以通过以下方式实现状态管理：

1. **使用 attach 字段**：该字段可以存储自定义的配置信息，用于记录流程状态。
2. **节点标记**：通过 `focus` 字段产生回调消息，间接实现状态跟踪。
3. **外部存储**：结合自定义动作，将状态信息保存到外部文件或数据库中。

### 复杂条件分支实现

对于复杂的业务逻辑，可以组合使用多种控制结构：

1. **嵌套条件**：通过多层 `next` 和 `on_error` 实现复杂的决策树。
2. **并行检测**：利用不同的识别算法同时检测多个条件。
3. **状态机模式**：将整个流程设计为状态机，每个节点代表一个状态。

通过合理运用这些技术，可以构建出能够应对各种复杂场景的智能化自动化流程。

**Section sources**
- [types.ts](file://src/stores/flow/types.ts)
- [edgeLinker.ts](file://src/core/parser/edgeLinker.ts)
- [edgeSlice.ts](file://src/stores/flow/slices/edgeSlice.ts)