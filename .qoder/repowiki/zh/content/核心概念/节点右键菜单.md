# 节点右键菜单

<cite>
**本文档引用的文件**   
- [NodeContextMenu.tsx](file://src/components/flow/nodes/components/NodeContextMenu.tsx)
- [nodeContextMenu.tsx](file://src/components/flow/nodes/nodeContextMenu.tsx)
- [nodeOperations.tsx](file://src/components/flow/nodes/utils/nodeOperations.tsx)
- [PipelineNode/index.tsx](file://src/components/flow/nodes/PipelineNode/index.tsx)
- [ExternalNode.tsx](file://src/components/flow/nodes/ExternalNode.tsx)
- [AnchorNode.tsx](file://src/components/flow/nodes/AnchorNode.tsx)
- [debugStore.ts](file://src/stores/debugStore.ts)
- [constants.ts](file://src/components/flow/nodes/constants.ts)
- [types.ts](file://src/stores/flow/types.ts)
</cite>

## 更新摘要
**变更内容**   
- 新增单节点测试功能：包括"测试此节点"、"测试识别"和"测试动作"三个测试选项
- 更新调试功能集成：与单节点测试模式深度集成
- 完善菜单配置：支持不同测试模式的直接调用

## 目录
1. [简介](#简介)
2. [核心组件](#核心组件)
3. [功能实现](#功能实现)
4. [菜单配置](#菜单配置)
5. [节点类型支持](#节点类型支持)
6. [调试功能集成](#调试功能集成)
7. [单节点测试功能](#单节点测试功能)
8. [代码结构分析](#代码结构分析)
9. [交互流程](#交互流程)
10. [状态管理](#状态管理)
11. [最佳实践](#最佳实践)

## 简介
节点右键菜单是 MaaPipelineEditor 中的重要交互功能，为用户提供了一种便捷的方式来操作工作流中的各个节点。该功能允许用户通过右键点击节点来访问一系列上下文相关的操作选项，包括复制节点名、保存为模板、设置断点等。菜单内容会根据当前节点类型和应用状态动态调整，确保用户只能执行适用的操作。

**Section sources**
- [NodeContextMenu.tsx](file://src/components/flow/nodes/components/NodeContextMenu.tsx)
- [nodeContextMenu.tsx](file://src/components/flow/nodes/nodeContextMenu.tsx)

## 核心组件
节点右键菜单功能由多个核心组件构成，这些组件协同工作以提供完整的用户体验。主要组件包括菜单渲染组件、菜单配置生成器和操作处理器。菜单渲染组件负责显示和管理菜单的可见性，菜单配置生成器根据节点类型和应用状态生成相应的菜单项，而操作处理器则执行用户选择的具体操作。

**Section sources**
- [NodeContextMenu.tsx](file://src/components/flow/nodes/components/NodeContextMenu.tsx)
- [nodeContextMenu.tsx](file://src/components/flow/nodes/nodeContextMenu.tsx)

## 功能实现
节点右键菜单的功能实现基于 React 和 Ant Design 的 Dropdown 组件，结合 Zustand 状态管理库来处理应用状态。当用户右键点击一个节点时，系统会创建一个包含该节点信息的上下文，并根据此上下文生成相应的菜单配置。菜单项的可见性和启用状态会根据节点类型和当前应用模式（如调试模式）进行动态调整。

```mermaid
flowchart TD
A[用户右键点击节点] --> B[触发ContextMenu事件]
B --> C[创建NodeContextMenu组件]
C --> D[获取节点信息和应用状态]
D --> E[调用getNodeContextMenuConfig]
E --> F[生成菜单配置]
F --> G[渲染菜单项]
G --> H[用户选择操作]
H --> I[执行相应操作处理器]
I --> J[更新应用状态]
```

**Diagram sources**
- [NodeContextMenu.tsx](file://src/components/flow/nodes/components/NodeContextMenu.tsx)
- [nodeContextMenu.tsx](file://src/components/flow/nodes/nodeContextMenu.tsx)

## 菜单配置
菜单配置是节点右键菜单的核心部分，它定义了菜单中显示的各个选项及其行为。配置包括菜单项的键值、标签、图标、点击处理器以及可见性和启用状态的条件。菜单项分为普通菜单项和分隔线两种类型，通过联合类型 NodeContextMenuConfig 进行定义。配置生成函数会根据节点类型和应用状态过滤和调整菜单项。

**Section sources**
- [nodeContextMenu.tsx](file://src/components/flow/nodes/nodeContextMenu.tsx)
- [nodeOperations.tsx](file://src/components/flow/nodes/utils/nodeOperations.tsx)

## 节点类型支持
节点右键菜单支持多种节点类型，包括 Pipeline 节点、External 节点和 Anchor 节点。不同类型的节点具有不同的菜单选项，例如只有 Pipeline 节点可以保存为模板。系统通过 NodeTypeEnum 枚举来定义和区分这些节点类型，并在菜单配置生成过程中根据节点类型调整可用的菜单项。

```mermaid
classDiagram
class NodeTypeEnum {
+Pipeline : "pipeline"
+External : "external"
+Anchor : "anchor"
}
class NodeContextMenuItem {
+key : string
+label : string
+icon : ReactNode | string
+iconSize? : number
+onClick : (node : NodeContextMenuNode) => void
+disabled? : boolean | ((node : NodeContextMenuNode) => boolean)
+disabledTip? : string
+visible? : (node : NodeContextMenuNode) => boolean
+danger? : boolean
}
class NodeContextMenuDivider {
+type : "divider"
+key : string
}
class NodeContextMenuConfig {
<<union>>
+NodeContextMenuItem
+NodeContextMenuDivider
}
NodeContextMenuItem <|-- NodeContextMenuConfig
NodeContextMenuDivider <|-- NodeContextMenuConfig
NodeTypeEnum ..> NodeContextMenuItem : "used in visible/dynamic logic"
```

**Diagram sources**
- [constants.ts](file://src/components/flow/nodes/constants.ts)
- [nodeContextMenu.tsx](file://src/components/flow/nodes/nodeContextMenu.tsx)

## 调试功能集成
节点右键菜单与应用的调试功能深度集成，特别是在调试模式下会显示额外的调试相关选项。这些选项包括设置调试入口节点、切换断点和单节点测试功能。系统通过 useDebugStore 钩子访问调试状态，并根据当前的调试模式和断点设置动态调整菜单内容。这种集成使得用户能够快速配置和控制调试会话。

**Section sources**
- [nodeContextMenu.tsx](file://src/components/flow/nodes/nodeContextMenu.tsx)
- [debugStore.ts](file://src/stores/debugStore.ts)

## 单节点测试功能

**更新** 新增单节点测试功能，提供三种测试模式以支持快速验证节点配置

节点右键菜单新增了强大的单节点测试功能，允许用户在不启动完整调试流程的情况下测试特定节点的各种配置。该功能通过统一的测试包装函数 `runDebugTest` 实现，支持三种不同的测试模式：

### 测试模式类型
- **node 模式**："测试此节点" - 运行当前节点但不执行后续节点
- **recognition 模式**："测试识别" - 仅测试识别功能，跳过动作执行
- **action 模式**："测试动作" - 仅测试动作功能，跳过识别环节

### 测试功能实现
每种测试模式都通过节点配置覆盖来实现特定的行为：

```mermaid
flowchart TD
A[用户选择测试选项] --> B{测试模式类型}
B --> |node| C[覆盖 next 和 on_error 为空数组]
B --> |recognition| D[设置 action 为 DoNothing, timeout 为 0]
B --> |action| E[设置 recognition 为 DirectHit]
C --> F[调用 runDebugTest]
D --> F
E --> F
F --> G[启动单节点测试]
G --> H[显示测试结果]
```

**Diagram sources**
- [nodeContextMenu.tsx](file://src/components/flow/nodes/nodeContextMenu.tsx)

### 测试处理器
- **handleTestNode**：测试完整节点执行，覆盖后续节点配置
- **handleTestRecognition**：仅测试识别功能，禁用动作执行
- **handleTestAction**：仅测试动作功能，使用直接命中识别

**Section sources**
- [nodeContextMenu.tsx](file://src/components/flow/nodes/nodeContextMenu.tsx)
- [debugStore.ts](file://src/stores/debugStore.ts)

## 代码结构分析
节点右键菜单的代码结构遵循清晰的分层设计，将菜单渲染、配置生成和操作处理分离到不同的文件中。NodeContextMenu.tsx 文件负责菜单的渲染和交互，nodeContextMenu.tsx 文件包含菜单配置的生成逻辑，而 nodeOperations.tsx 文件则实现了具体的操作处理函数。这种分离提高了代码的可维护性和可测试性。

```mermaid
graph TB
subgraph "渲染层"
A[NodeContextMenu.tsx]
end
subgraph "逻辑层"
B[nodeContextMenu.tsx]
end
subgraph "操作层"
C[nodeOperations.tsx]
end
A --> B
B --> C
C --> D[(状态管理)]
D --> A
```

**Diagram sources**
- [NodeContextMenu.tsx](file://src/components/flow/nodes/components/NodeContextMenu.tsx)
- [nodeContextMenu.tsx](file://src/components/flow/nodes/nodeContextMenu.tsx)
- [nodeOperations.tsx](file://src/components/flow/nodes/utils/nodeOperations.tsx)

## 交互流程
节点右键菜单的交互流程从用户右键点击节点开始，经过一系列的事件处理和状态更新，最终执行用户选择的操作。流程包括菜单的显示、菜单项的生成、用户选择的处理和操作的执行。每个步骤都经过精心设计，以确保流畅的用户体验和正确的功能实现。

**Section sources**
- [NodeContextMenu.tsx](file://src/components/flow/nodes/components/NodeContextMenu.tsx)
- [nodeContextMenu.tsx](file://src/components/flow/nodes/nodeContextMenu.tsx)

## 状态管理
节点右键菜单的状态管理依赖于 Zustand 库，通过 useDebugStore 和其他状态存储来访问和更新应用状态。菜单的显示状态（打开/关闭）在组件本地管理，而与菜单项相关的应用状态（如断点设置）则存储在全局状态中。这种混合状态管理方法既保证了性能又确保了状态的一致性。

**Section sources**
- [NodeContextMenu.tsx](file://src/components/flow/nodes/components/NodeContextMenu.tsx)
- [debugStore.ts](file://src/stores/debugStore.ts)

## 最佳实践
在使用和扩展节点右键菜单功能时，应遵循一些最佳实践。这些包括保持菜单项的简洁性、确保操作的可逆性、提供清晰的反馈信息以及合理使用禁用状态来指导用户。此外，新功能的添加应考虑与其他系统组件的集成，以提供一致的用户体验。

**Section sources**
- [nodeContextMenu.tsx](file://src/components/flow/nodes/nodeContextMenu.tsx)
- [nodeOperations.tsx](file://src/components/flow/nodes/utils/nodeOperations.tsx)